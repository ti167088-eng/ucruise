
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteFlow - Smart Driver Assignment Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Design System - Utilitarian + Cinematic Theme */
            --bg-primary: #0F1724;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            
            --accent-primary: #0EA5A4;
            --accent-secondary: #F59E0B;
            --accent-primary-hover: #0d8f8e;
            --accent-secondary-hover: #d97706;
            
            --text-muted: #94A3B8;
            --text-strong: #E6EEF6;
            --text-body: #cbd5e1;
            
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
            
            /* Legacy mappings for compatibility */
            --primary-500: #0EA5A4;
            --primary-600: #0d8f8e;
            --primary-700: #0c7a79;
            --primary-50: #1e1b4b;
            --primary-100: #312e81;
            
            --success-500: #10b981;
            --success-100: #064e3b;
            --warning-500: #f59e0b;
            --warning-100: #451a03;
            --error-500: #ef4444;
            --error-100: #450a0a;
            
            --gray-50: #0F1724;
            --gray-100: #111827;
            --gray-200: #1e293b;
            --gray-300: #334155;
            --gray-400: #475569;
            --gray-500: #94a3b8;
            --gray-600: #cbd5e1;
            --gray-700: #e2e8f0;
            --gray-800: #E6EEF6;
            --gray-900: #f8fafc;
            
            --surface-white: #0F1724;
            --surface-gray: #111827;
            
            /* Cinematic Layered Shadows */
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.4);
            --shadow-md: 0 2px 8px -1px rgb(0 0 0 / 0.5), 0 4px 6px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 8px 20px -4px rgb(0 0 0 / 0.6), 0 4px 12px -4px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 16px 40px -8px rgb(0 0 0 / 0.7), 0 8px 20px -6px rgb(0 0 0 / 0.5);
            --shadow-glow: 0 0 20px rgba(14, 165, 164, 0.3);
            --shadow-spotlight: 0 0 60px 20px rgba(14, 165, 164, 0.15);
            
            /* Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Spacing Scale */
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 2.5rem;
            
            /* Motion Tokens */
            --duration-fast: 120ms;
            --duration-medium: 240ms;
            --duration-slow: 320ms;
            --easing-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
            --easing-decelerate: cubic-bezier(0.0, 0.0, 0.2, 1);
            --easing-accelerate: cubic-bezier(0.4, 0.0, 1, 1);
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-body);
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at 20% 30%, rgba(14, 165, 164, 0.08) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 70%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: 100vh;
            gap: 0;
        }

        /* Sidebar Styling */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            transition: transform var(--duration-slow) var(--easing-standard);
            position: relative;
            z-index: 10;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: var(--space-xl);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
            color: var(--text-strong);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-header::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .logo i {
            font-size: 24px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.025em;
        }

        .tagline {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }

        .sidebar-content {
            flex: 1;
            padding: var(--space-lg);
        }

        .section {
            margin-bottom: var(--space-xl);
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .section-title i {
            font-size: 14px;
            color: var(--primary-500);
        }

        /* Form Controls */
        .form-group {
            margin-bottom: var(--space-md);
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--space-xs);
        }

        .form-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            font-size: 13px;
            transition: all var(--duration-fast) var(--easing-standard);
            background: var(--bg-card);
            color: var(--text-strong);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.15);
            background: var(--bg-secondary);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right var(--space-sm) center;
            background-repeat: no-repeat;
            background-size: 16px 12px;
            padding-right: var(--space-2xl);
        }

        .range-input {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--gray-200);
            outline: none;
            appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-500);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease;
        }

        .range-input::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            width: 100%;
            margin-bottom: var(--space-xs);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--text-strong);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width var(--duration-medium) var(--easing-standard), 
                        height var(--duration-medium) var(--easing-standard);
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover {
            background: var(--accent-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow), var(--shadow-md);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-body);
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            color: var(--text-strong);
            transform: translateY(-1px);
        }
        
        .btn-secondary:active {
            transform: translateY(0);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xs);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }

        .stat-card {
            background: var(--bg-card);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all var(--duration-fast) var(--easing-standard);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transform: scaleX(0);
            transition: transform var(--duration-medium) var(--easing-standard);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
            border-color: rgba(14, 165, 164, 0.3);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-strong);
            margin-bottom: var(--space-xs);
            background: linear-gradient(135deg, var(--accent-primary), var(--text-strong));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
        }

        /* Analytics Cards */
        .analytics-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all var(--duration-fast) var(--easing-standard);
        }
        
        .analytics-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: rgba(14, 165, 164, 0.2);
        }

        .analytics-header {
            padding: var(--space-lg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(135deg, rgba(14, 165, 164, 0.05), transparent);
        }

        .analytics-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .analytics-body {
            padding: var(--space-lg);
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 12px;
            color: var(--gray-600);
            font-weight: 400;
        }

        .metric-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Map Container */
        .map-container {
            position: relative;
            background: var(--surface-gray);
            display: flex;
            flex-direction: column;
        }

        .map-header {
            background: var(--surface-white);
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .map-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .map-controls {
            display: flex;
            gap: var(--space-sm);
        }

        .map-btn {
            padding: var(--space-xs) var(--space-md);
            background: var(--bg-card);
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-body);
            cursor: pointer;
            transition: all var(--duration-fast) var(--easing-standard);
        }

        .map-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .map-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--text-strong);
            box-shadow: var(--shadow-glow);
        }

        #map {
            flex: 1;
            width: 100%;
            border: none;
        }

        /* Floating Elements */
        .floating-legend {
            position: absolute;
            bottom: var(--space-xl);
            left: var(--space-xl);
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: var(--space-lg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.12);
            min-width: 250px;
            transition: all var(--duration-medium) var(--easing-standard);
        }
        
        .floating-legend:hover {
            background: rgba(17, 24, 39, 0.95);
            box-shadow: var(--shadow-xl), var(--shadow-glow);
            transform: translateY(-2px);
        }

        .legend-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: var(--space-md);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
            font-size: 12px;
            color: var(--gray-600);
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .route-info-popup {
            position: absolute;
            top: var(--space-xl);
            right: var(--space-xl);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--space-lg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
            max-width: 300px;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-top: var(--space-xs);
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-success { background: var(--success-500); }
        .progress-warning { background: var(--warning-500); }
        .progress-error { background: var(--error-500); }

        /* Alerts */
        .alert {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: 12px;
            margin-bottom: var(--space-sm);
            animation: slideInLeft 0.3s ease;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-success {
            background: var(--success-100);
            color: var(--success-500);
            border-left: 3px solid var(--success-500);
        }

        .alert-warning {
            background: var(--warning-100);
            color: var(--warning-500);
            border-left: 3px solid var(--warning-500);
        }

        .alert-error {
            background: var(--error-100);
            color: var(--error-500);
            border-left: 3px solid var(--error-500);
        }

        /* Enhanced Cluster Colors with Better Differentiation */
        .cluster-palette {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            margin-top: var(--space-md);
        }

        .cluster-color {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }

        .cluster-color:hover {
            transform: scale(1.25);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            border-color: var(--accent-primary);
            animation: markerPulse 1.5s infinite;
        }

        .cluster-color.active {
            transform: scale(1.2);
            border-color: var(--accent-primary);
            box-shadow: 0 0 24px rgba(14, 165, 164, 0.6), var(--shadow-md);
            animation: markerPulse 2s infinite;
        }

        .cluster-color.active::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        }

        /* Marker animations */
        @keyframes markerBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }

        @keyframes markerDrop {
            0% { 
                transform: translateY(-100px);
                opacity: 0;
            }
            60% {
                transform: translateY(5px);
                opacity: 1;
            }
            80% {
                transform: translateY(-3px);
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes markerPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(14, 165, 164, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(14, 165, 164, 0);
            }
        }
        
        @keyframes spotlightReveal {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Cinematic spotlight overlay */
        .map-spotlight {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at var(--spotlight-x, 50%) var(--spotlight-y, 50%), 
                        transparent 15%, 
                        rgba(15, 23, 36, 0.6) 50%);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--duration-slow) var(--easing-standard);
            z-index: 5;
        }
        
        .map-spotlight.active {
            opacity: 1;
        }

        /* Filter result badge */
        .filter-badge {
            display: inline-block;
            background: var(--accent-primary);
            color: var(--text-strong);
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: var(--space-xs);
            font-weight: 700;
            box-shadow: 0 0 12px rgba(14, 165, 164, 0.4);
            animation: markerPulse 2s infinite;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 320px 1fr;
            }
            
            .sidebar {
                font-size: 13px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                max-height: 50vh;
                position: absolute;
                width: 100%;
                z-index: 100;
            }

            .sidebar.collapsed {
                transform: translateY(-100%);
            }
            
            .floating-legend,
            .route-info-popup {
                position: relative;
                margin: var(--space-md);
            }
        }

        /* Custom Scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* Smart Suggestions Toast */
        .toast-container {
            position: fixed;
            bottom: var(--space-xl);
            right: var(--space-xl);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            max-width: 420px;
        }
        
        .toast {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            animation: slideInUp var(--duration-slow) var(--easing-decelerate);
            position: relative;
            overflow: hidden;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }
        
        .toast-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }
        
        .toast-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-strong);
            font-size: 16px;
        }
        
        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-strong);
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--text-body);
            margin-bottom: var(--space-md);
            line-height: 1.5;
        }
        
        .toast-actions {
            display: flex;
            gap: var(--space-xs);
        }
        
        .toast-btn {
            flex: 1;
            padding: var(--space-xs) var(--space-sm);
            border: none;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-fast) var(--easing-standard);
        }
        
        .toast-btn-primary {
            background: var(--accent-primary);
            color: var(--text-strong);
        }
        
        .toast-btn-primary:hover {
            background: var(--accent-primary-hover);
            transform: translateY(-1px);
        }
        
        .toast-btn-secondary {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toast-btn-secondary:hover {
            color: var(--text-body);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-sm { font-size: 12px; }
        .text-xs { font-size: 11px; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .opacity-75 { opacity: 0.75; }
        .mb-0 { margin-bottom: 0; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Loading route analytics...</div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-route"></i>
                    <h1>RouteFlow</h1>
                </div>
                <div class="tagline">Smart Driver Assignment Platform</div>
            </div>

            <div class="sidebar-content">
                <!-- Quick Stats -->
                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Overview
                        <span class="filter-badge" id="filterBadge" style="display:none;">0</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalRoutes">0</div>
                            <div class="stat-label">Active Routes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">Users Assigned</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgUtilization">0%</div>
                            <div class="stat-label">Avg Utilization</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalDrivers">0</div>
                            <div class="stat-label">Active Drivers</div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-filter"></i>
                        Filters
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="searchInput">Search Routes or Users</label>
                        <input type="text" id="searchInput" class="form-input" placeholder="Enter ID, name, or keyword...">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clusterSelect">Route Selection</label>
                        <select id="clusterSelect" class="form-input form-select">
                            <option value="all">All Routes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="utilizationRange">
                            Min Utilization: <span id="utilizationValue" class="font-semibold">0%</span>
                        </label>
                        <input type="range" id="utilizationRange" class="range-input" min="0" max="100" value="0">
                    </div>
                </div>

                <!-- Display Controls -->
                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-eye"></i>
                        Display Options
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="toggleUsers()" id="toggleUsersBtn">
                            <i class="fas fa-users"></i> Users
                        </button>
                        <button class="btn btn-secondary" onclick="toggleDrivers()" id="toggleDriversBtn">
                            <i class="fas fa-car"></i> Drivers
                        </button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="toggleRouteLines()" id="toggleRouteLinesBtn">
                            <i class="fas fa-route"></i> Pickup Routes
                        </button>
                        <button class="btn btn-secondary" onclick="toggleHeatmap()" id="toggleHeatmapBtn">
                            <i class="fas fa-fire"></i> Heatmap
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="showOptimalPaths()" id="showOptimalBtn">
                        <i class="fas fa-magic"></i> Show Optimal Paths
                    </button>
                </div>

                <!-- Performance Analytics -->
                <div class="section">
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <div class="analytics-title">
                                <i class="fas fa-tachometer-alt"></i>
                                Performance Metrics
                            </div>
                        </div>
                        <div class="analytics-body">
                            <div class="metric-row">
                                <span class="metric-label">Assignment Rate</span>
                                <span class="metric-value" id="assignmentRate">0%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Capacity Utilization</span>
                                <span class="metric-value" id="capacityUtilization">0%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Avg Distance</span>
                                <span class="metric-value" id="avgDistance">0 km</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Efficiency Score</span>
                                <span class="metric-value" id="efficiencyScore">0/10</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Route Quality -->
                <div class="section">
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <div class="analytics-title">
                                <i class="fas fa-award"></i>
                                Route Quality
                            </div>
                        </div>
                        <div class="analytics-body">
                            <div class="metric-row">
                                <span class="metric-label">High Efficiency (≥80%)</span>
                                <span class="metric-value" id="highEfficiencyRoutes">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Medium Efficiency (50-79%)</span>
                                <span class="metric-value" id="mediumEfficiencyRoutes">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Low Efficiency (<50%)</span>
                                <span class="metric-value" id="lowEfficiencyRoutes">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Efficiency Alerts -->
                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        System Alerts
                    </div>
                    <div id="alertsContainer">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> System initialized successfully
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-download"></i>
                        Export & Reports
                    </div>
                    <button class="btn btn-primary" onclick="exportAnalytics()">
                        <i class="fas fa-file-csv"></i> Export Data
                    </button>
                    <button class="btn btn-secondary" onclick="generateReport()">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                    <button class="btn btn-secondary" onclick="exportMapImage()">
                        <i class="fas fa-camera"></i> Capture Map
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Map Area -->
        <div class="map-container">
            <div class="map-header">
                <h2 class="map-title">Live Route Visualization</h2>
                <div class="map-controls">
                    <button class="map-btn" onclick="centerOnOffice()">
                        <i class="fas fa-home"></i> Center on Office
                    </button>
                    <button class="map-btn" onclick="fitAllRoutes()">
                        <i class="fas fa-expand"></i> Fit All Routes
                    </button>
                    <button class="map-btn" onclick="togglePlaceNames()" id="togglePlaceNamesBtn">
                        <i class="fas fa-map-marker-alt"></i> Place Names
                    </button>
                    <button class="map-btn" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div id="map"></div>
            
            <!-- Cinematic Spotlight Overlay -->
            <div class="map-spotlight" id="mapSpotlight"></div>

            <!-- Floating Legend -->
            <div class="floating-legend">
                <div class="legend-title">Map Legend</div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: linear-gradient(45deg, #ef4444, #dc2626);">
                        🏢
                    </div>
                    <span>Office Headquarters</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: linear-gradient(45deg, #3b82f6, #2563eb);">
                        🚗
                    </div>
                    <span>Driver Positions</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: linear-gradient(45deg, #10b981, #059669);">
                        👤
                    </div>
                    <span>User Locations</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: linear-gradient(45deg, #f59e0b, #d97706);">
                        🛣️
                    </div>
                    <span>Pickup Routes (Office → Users)</span>
                </div>
                <div class="cluster-palette" id="clusterPalette"></div>
            </div>

            <!-- Route Info Popup -->
            <div class="route-info-popup" id="routeInfoPopup">
                <div id="routeInfoContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = "/routes";
        const OFFICE_LOCATION = { lat: 30.6810489, lng: 76.7260711 };
        
        // Enhanced Color Palette with Better Differentiation
        const ROUTE_COLORS = [
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
            '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
            '#ee5a24', '#0abde3', '#10ac84', '#8395a7', '#222f3e',
            '#c8d6e5', '#576574', '#a4b0be', '#2f3542', '#40407a'
        ];

        // Global Variables
        let map;
        let directionsService;
        
        // ✅ OPTIMIZATION 1: Cache original routes (immutable)
        let originalRoutes = []; // Never modified after initial fetch
        let displayRoutes = [];  // Filtered/searched routes for display
        
        // ✅ OPTIMIZATION 3: Track markers by ID for differential updates
        let markersById = new Map(); // Map<markerId, markerObject>
        let routeRenderersById = new Map(); // Map<routeId, rendererObject>
        
        let markers = {
            office: null
        };
        let heatmap = null;
        let sharedInfoWindow = null; // ✅ OPTIMIZATION 6: Single reusable InfoWindow
        
        // Display States
        let displayState = {
            users: true,
            drivers: true,
            routeLines: true,
            heatmap: false,
            optimalPaths: false
        };

        // ✅ OPTIMIZATION 4: Precomputed SVG icon templates
        const iconTemplates = {
            office: null,
            driver: {},
            user: {},
            sequence: {}
        };

        // ✅ OPTIMIZATION 2: Debounce timers
        let searchDebounceTimer = null;
        let rangeDebounceTimer = null;

        // Map style configurations
        let showPlaceNames = false;
        const originalMapStyles = [
            {
                elementType: "geometry",
                stylers: [{ color: "#1e293b" }]
            },
            {
                elementType: "labels.text.stroke",
                stylers: [{ color: "#0f172a" }]
            },
            {
                elementType: "labels.text.fill",
                stylers: [{ color: "#94a3b8" }]
            },
            {
                featureType: "administrative.locality",
                elementType: "labels.text.fill",
                stylers: [{ color: "#cbd5e1" }]
            },
            {
                featureType: "poi",
                elementType: "labels.text.fill",
                stylers: [{ color: "#64748b" }]
            },
            {
                featureType: "poi.park",
                elementType: "geometry",
                stylers: [{ color: "#334155" }]
            },
            {
                featureType: "poi.park",
                elementType: "labels.text.fill",
                stylers: [{ color: "#64748b" }]
            },
            {
                featureType: "road",
                elementType: "geometry",
                stylers: [{ color: "#475569" }]
            },
            {
                featureType: "road",
                elementType: "geometry.stroke",
                stylers: [{ color: "#334155" }]
            },
            {
                featureType: "road",
                elementType: "labels.text.fill",
                stylers: [{ color: "#94a3b8" }]
            },
            {
                featureType: "road.highway",
                elementType: "geometry",
                stylers: [{ color: "#64748b" }]
            },
            {
                featureType: "road.highway",
                elementType: "geometry.stroke",
                stylers: [{ color: "#475569" }]
            },
            {
                featureType: "road.highway",
                elementType: "labels.text.fill",
                stylers: [{ color: "#cbd5e1" }]
            },
            {
                featureType: "transit",
                elementType: "geometry",
                stylers: [{ color: "#334155" }]
            },
            {
                featureType: "transit.station",
                elementType: "labels.text.fill",
                stylers: [{ color: "#64748b" }]
            },
            {
                featureType: "water",
                elementType: "geometry",
                stylers: [{ color: "#0f172a" }]
            },
            {
                featureType: "water",
                elementType: "labels.text.fill",
                stylers: [{ color: "#64748b" }]
            },
            {
                featureType: "water",
                elementType: "labels.text.stroke",
                stylers: [{ color: "#0f172a" }]
            }
        ];

        const cleanMapStyles = [
            ...originalMapStyles,
            {
                featureType: "all",
                elementType: "labels.text",
                stylers: [{ visibility: "off" }]
            },
            {
                featureType: "all",
                elementType: "labels.icon",
                stylers: [{ visibility: "off" }]
            },
            {
                featureType: "poi",
                stylers: [{ visibility: "off" }]
            },
            {
                featureType: "administrative.locality",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            },
            {
                featureType: "transit.station",
                stylers: [{ visibility: "off" }]
            },
            {
                featureType: "road",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }
        ];

        // Initialize Application
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: OFFICE_LOCATION,
                zoom: 12,
                styles: cleanMapStyles,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true
            });

            directionsService = new google.maps.DirectionsService();
            sharedInfoWindow = new google.maps.InfoWindow(); // ✅ Single InfoWindow instance

            // ✅ OPTIMIZATION 4: Precompute icon templates
            precomputeIconTemplates();
            
            createOfficeMarker();
            loadRouteData();

            // ✅ OPTIMIZATION 2: Add debounced event listeners
            setupDebouncedListeners();
        }

        // ✅ OPTIMIZATION 4: Precompute SVG icon templates
        function precomputeIconTemplates() {
            // Office icon
            iconTemplates.office = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="24" cy="24" r="20" fill="#ef4444" stroke="#ffffff" stroke-width="4"/>
                    <text x="24" y="30" font-family="Arial" font-size="16" text-anchor="middle" fill="white">🏢</text>
                </svg>
            `);
        }

        function getDriverIcon(index, color) {
            const key = `${index}_${color}`;
            if (!iconTemplates.driver[key]) {
                iconTemplates.driver[key] = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="56" height="56" viewBox="0 0 56 56" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="grad${index}" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                                <stop offset="100%" style="stop-color:${adjustBrightness(color, -30)};stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="28" cy="28" r="24" fill="url(#grad${index})" stroke="#ffffff" stroke-width="4"/>
                        <text x="28" y="34" font-family="Arial" font-size="18" text-anchor="middle" fill="white" font-weight="bold">🚗</text>
                        <text x="28" y="46" font-family="Arial" font-size="10" text-anchor="middle" fill="white" font-weight="bold">${index + 1}</text>
                    </svg>
                `);
            }
            return iconTemplates.driver[key];
        }

        function getUserIcon(routeIndex, userIndex, color) {
            const key = `${routeIndex}_${userIndex}_${color}`;
            if (!iconTemplates.user[key]) {
                iconTemplates.user[key] = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="usergrad${routeIndex}_${userIndex}" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                                <stop offset="100%" style="stop-color:${adjustBrightness(color, -20)};stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="16" cy="16" r="12" fill="url(#usergrad${routeIndex}_${userIndex})" stroke="#ffffff" stroke-width="2"/>
                        <text x="16" y="20" font-family="Arial" font-size="12" text-anchor="middle" fill="white">👤</text>
                    </svg>
                `);
            }
            return iconTemplates.user[key];
        }

        // ✅ OPTIMIZATION 2: Setup debounced event listeners
        function setupDebouncedListeners() {
            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("input", () => {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(handleSearch, 300); // 300ms debounce
            });

            const rangeInput = document.getElementById("utilizationRange");
            rangeInput.addEventListener("input", () => {
                // Update display immediately
                const value = rangeInput.value;
                document.getElementById("utilizationValue").textContent = `${value}%`;
                
                // Debounce the actual filtering
                clearTimeout(rangeDebounceTimer);
                rangeDebounceTimer = setTimeout(filterByUtilization, 250); // 250ms debounce
            });

            const clusterSelect = document.getElementById("clusterSelect");
            clusterSelect.addEventListener("change", filterCluster);
        }

        function createOfficeMarker() {
            markers.office = new google.maps.Marker({
                position: OFFICE_LOCATION,
                map: map,
                title: "Office Headquarters",
                icon: {
                    url: iconTemplates.office,
                    scaledSize: new google.maps.Size(48, 48),
                    anchor: new google.maps.Point(24, 24)
                },
                zIndex: 1000
            });

            markers.office.addListener("click", () => {
                sharedInfoWindow.setContent(`
                    <div style="padding: 15px; font-family: Inter, sans-serif; background: #0f172a; color: #f1f5f9; border-radius: 8px; min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #f1f5f9; display: flex; align-items: center; gap: 8px;">
                            🏢 Office Headquarters
                        </h3>
                        <p style="margin: 0; color: #94a3b8; font-size: 13px;">Central dispatch location</p>
                        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 12px;">
                            📍 ${OFFICE_LOCATION.lat.toFixed(6)}, ${OFFICE_LOCATION.lng.toFixed(6)}
                        </p>
                    </div>
                `);
                sharedInfoWindow.open(map, markers.office);
            });
        }

        async function loadRouteData() {
            try {
                const response = await fetch(API_URL);
                const routes = await response.json();
                
                if (Array.isArray(routes)) {
                    // ✅ OPTIMIZATION 1: Store original data (never modified)
                    originalRoutes = routes;
                    displayRoutes = [...routes]; // Initial display = all routes
                    
                    hideLoading();
                    updateUI();
                    renderMap();
                } else {
                    throw new Error('Invalid route data format');
                }
            } catch (error) {
                console.error('Error loading route data:', error);
                hideLoading();
                showAlert('error', 'Failed to load route data. Please check if the server is running.');
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateUI() {
            populateRouteDropdown();
            updateStats();
            updateAnalytics();
            createClusterPalette();
            updateFilterBadge();
        }

        function updateFilterBadge() {
            const badge = document.getElementById('filterBadge');
            if (displayRoutes.length < originalRoutes.length) {
                badge.textContent = displayRoutes.length;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function populateRouteDropdown() {
            const select = document.getElementById("clusterSelect");
            select.innerHTML = '<option value="all">All Routes</option>';
            
            displayRoutes.forEach((route, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = `Route ${index + 1} - ${route.assigned_users.length} users (${((route.assigned_users.length / route.vehicle_type) * 100).toFixed(0)}% util)`;
                select.appendChild(option);
            });
        }

        function createClusterPalette() {
            const container = document.getElementById('clusterPalette');
            container.innerHTML = '';
            
            displayRoutes.forEach((route, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'cluster-color';
                colorDiv.style.background = `linear-gradient(45deg, ${ROUTE_COLORS[index % ROUTE_COLORS.length]}, ${adjustBrightness(ROUTE_COLORS[index % ROUTE_COLORS.length], -20)})`;
                colorDiv.title = `Route ${index + 1} - Click to highlight`;
                colorDiv.textContent = index + 1;
                colorDiv.onclick = () => highlightRoute(index);
                container.appendChild(colorDiv);
            });
        }

        // ✅ OPTIMIZATION 3: Differential rendering with marker tracking
        function renderMap() {
            const currentDisplayIds = new Set();
            let heatmapData = [];

            displayRoutes.forEach((route, index) => {
                const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
                const routeId = `route_${route.driver_id}`;
                currentDisplayIds.add(routeId);

                renderRoute(route, index, color, routeId);
                
                route.assigned_users.forEach(user => {
                    heatmapData.push(new google.maps.LatLng(parseFloat(user.lat), parseFloat(user.lng)));
                    currentDisplayIds.add(`user_${user.user_id}`);
                });
            });

            // ✅ Remove markers that are no longer in displayRoutes
            for (const [id, markerObj] of markersById.entries()) {
                if (!currentDisplayIds.has(id)) {
                    markerObj.marker.setMap(null);
                    markersById.delete(id);
                }
            }

            // ✅ Remove route renderers no longer needed
            for (const [id, rendererObj] of routeRenderersById.entries()) {
                if (!currentDisplayIds.has(id)) {
                    if (rendererObj.renderer) rendererObj.renderer.setMap(null);
                    if (rendererObj.polyline) rendererObj.polyline.setMap(null);
                    routeRenderersById.delete(id);
                }
            }

            // Heatmap
            if (heatmap) heatmap.setMap(null);
            if (displayState.heatmap && heatmapData.length > 0) {
                createHeatmap(heatmapData);
            }

            updateDisplayButtons();
        }

        function renderRoute(route, index, color, routeId) {
            const driverLat = parseFloat(route.latitude);
            const driverLng = parseFloat(route.longitude);
            const utilization = route.assigned_users.length / route.vehicle_type;
            const driverId = `driver_${route.driver_id}`;

            // ✅ Driver marker - create or update
            if (displayState.drivers) {
                if (!markersById.has(driverId)) {
                    const driverMarker = new google.maps.Marker({
                        position: { lat: driverLat, lng: driverLng },
                        map: map,
                        title: `Driver ${route.driver_id}`,
                        icon: {
                            url: getDriverIcon(index, color),
                            scaledSize: new google.maps.Size(56, 56),
                            anchor: new google.maps.Point(28, 28)
                        },
                        zIndex: 500,
                        animation: google.maps.Animation.DROP // ✅ Drop animation
                    });

                    driverMarker.addListener("click", () => {
                        const content = createDriverInfoWindow(route, index, utilization);
                        sharedInfoWindow.setContent(content);
                        sharedInfoWindow.open(map, driverMarker);
                        showRouteInfo(route, index);
                    });

                    markersById.set(driverId, { marker: driverMarker, type: 'driver' });
                } else {
                    // Update existing marker position if changed
                    const existing = markersById.get(driverId);
                    const currentPos = existing.marker.getPosition();
                    if (currentPos.lat() !== driverLat || currentPos.lng() !== driverLng) {
                        existing.marker.setPosition({ lat: driverLat, lng: driverLng });
                    }
                }
            } else {
                // Hide driver markers
                if (markersById.has(driverId)) {
                    markersById.get(driverId).marker.setMap(null);
                    markersById.delete(driverId);
                }
            }

            // ✅ User markers - create or update
            route.assigned_users.forEach((user, userIndex) => {
                const userLat = parseFloat(user.lat);
                const userLng = parseFloat(user.lng);
                const userId = `user_${user.user_id}`;

                if (displayState.users) {
                    if (!markersById.has(userId)) {
                        const userMarker = new google.maps.Marker({
                            position: { lat: userLat, lng: userLng },
                            map: map,
                            title: `User ${user.user_id}`,
                            icon: {
                                url: getUserIcon(index, userIndex, color),
                                scaledSize: new google.maps.Size(32, 32),
                                anchor: new google.maps.Point(16, 16)
                            },
                            zIndex: 300,
                            animation: google.maps.Animation.DROP
                        });

                        userMarker.addListener("click", () => {
                            const content = createUserInfoWindow(user, route, index);
                            sharedInfoWindow.setContent(content);
                            sharedInfoWindow.open(map, userMarker);
                        });

                        // ✅ Hover animation
                        userMarker.addListener("mouseover", () => {
                            userMarker.setAnimation(google.maps.Animation.BOUNCE);
                        });
                        userMarker.addListener("mouseout", () => {
                            userMarker.setAnimation(null);
                        });

                        markersById.set(userId, { marker: userMarker, type: 'user' });
                    } else {
                        const existing = markersById.get(userId);
                        const currentPos = existing.marker.getPosition();
                        if (currentPos.lat() !== userLat || currentPos.lng() !== userLng) {
                            existing.marker.setPosition({ lat: userLat, lng: userLng });
                        }
                    }
                } else {
                    if (markersById.has(userId)) {
                        markersById.get(userId).marker.setMap(null);
                        markersById.delete(userId);
                    }
                }
            });

            // Routes
            if (displayState.routeLines && route.assigned_users.length > 0) {
                createSequentialRoute(route, color, index, routeId);
            } else {
                if (routeRenderersById.has(routeId)) {
                    const rendererObj = routeRenderersById.get(routeId);
                    if (rendererObj.renderer) rendererObj.renderer.setMap(null);
                    if (rendererObj.polyline) rendererObj.polyline.setMap(null);
                    routeRenderersById.delete(routeId);
                }
            }
        }

        function createDriverInfoWindow(route, index, utilization) {
            const efficiencyRating = utilization >= 0.8 ? '🟢 Excellent' : utilization >= 0.6 ? '🟡 Good' : '🔴 Needs Improvement';
            const utilizationPercent = (utilization * 100).toFixed(1);
            
            return `
                <div style="font-family: Inter, sans-serif; min-width: 300px; padding: 20px; background: #0f172a; color: #f1f5f9; border-radius: 12px; border: 1px solid #334155;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #334155;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(45deg, ${ROUTE_COLORS[index % ROUTE_COLORS.length]}, ${adjustBrightness(ROUTE_COLORS[index % ROUTE_COLORS.length], -30)}); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                            🚗
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #f1f5f9; font-size: 18px;">Driver ${route.driver_id}</h3>
                            <p style="margin: 0; color: #94a3b8; font-size: 13px;">Route ${index + 1}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 10px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8; font-size: 13px;">🚙 Vehicle:</span>
                            <span style="font-weight: 600; color: #f1f5f9; font-size: 13px;">${route.vehicle_id}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8; font-size: 13px;">👥 Capacity:</span>
                            <span style="font-weight: 600; color: #f1f5f9; font-size: 13px;">${route.vehicle_type} passengers</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8; font-size: 13px;">✅ Assigned:</span>
                            <span style="font-weight: 600; color: #f1f5f9; font-size: 13px;">${route.assigned_users.length} users</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8; font-size: 13px;">📊 Utilization:</span>
                            <span style="font-weight: 600; color: #f1f5f9; font-size: 13px;">${utilizationPercent}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8; font-size: 13px;">⚡ Efficiency:</span>
                            <span style="font-weight: 600; color: #f1f5f9; font-size: 13px;">${efficiencyRating}</span>
                        </div>
                    </div>
                    
                    <div style="background: #1e293b; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #94a3b8;">Utilization Progress</span>
                            <span style="font-size: 11px; color: #94a3b8;">${utilizationPercent}%</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #334155; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f97316 50%, #22c55e 100%); width: ${utilizationPercent}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <p style="margin: 0; font-size: 11px; color: #64748b; text-align: center;">
                        Click users to see their details • Real driving routes shown
                    </p>
                </div>
            `;
        }

        function createUserInfoWindow(user, route, routeIndex) {
            const distanceToDriver = haversineDistance(
                route.latitude, route.longitude,
                user.lat, user.lng
            );
            
            return `
                <div style="font-family: Inter, sans-serif; min-width: 280px; padding: 18px; background: #0f172a; color: #f1f5f9; border-radius: 12px; border: 1px solid #334155;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #334155;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(45deg, ${ROUTE_COLORS[routeIndex % ROUTE_COLORS.length]}, ${adjustBrightness(ROUTE_COLORS[routeIndex % ROUTE_COLORS.length], -20)}); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                            👤
                        </div>
                        <div>
                            <h4 style="margin: 0; color: #f1f5f9; font-size: 16px;">User ${user.user_id}</h4>
                            <p style="margin: 0; color: #94a3b8; font-size: 12px;">Route ${routeIndex + 1}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 8px; margin-bottom: 14px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8; font-size: 12px;">📛 Name:</span>
                            <span style="font-weight: 500; color: #f1f5f9; font-size: 12px;">${user.first_name || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8; font-size: 12px;">🏢 Office Distance:</span>
                            <span style="font-weight: 500; color: #f1f5f9; font-size: 12px;">${user.office_distance} km</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8; font-size: 12px;">🚗 To Driver:</span>
                            <span style="font-weight: 500; color: #f1f5f9; font-size: 12px;">${distanceToDriver.toFixed(1)} km</span>
                        </div>
                        ${user.email ? `
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8; font-size: 12px;">📧 Email:</span>
                            <span style="font-weight: 500; color: #f1f5f9; font-size: 11px;">${user.email}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 11px; color: #94a3b8;">
                            📍 ${parseFloat(user.lat).toFixed(4)}, ${parseFloat(user.lng).toFixed(4)}
                        </p>
                    </div>
                </div>
            `;
        }

        function createSequentialRoute(route, color, routeIndex, routeId) {
            if (route.assigned_users.length === 0) return;

            // Check if route already exists
            if (routeRenderersById.has(routeId)) {
                return; // Already rendered
            }

            const waypoints = route.assigned_users.map(user => ({
                location: { lat: parseFloat(user.lat), lng: parseFloat(user.lng) },
                stopover: true
            }));

            const directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                preserveViewport: true,
                polylineOptions: {
                    strokeColor: color,
                    strokeOpacity: 0.8,
                    strokeWeight: 6,
                    zIndex: 300
                },
            });
            directionsRenderer.setMap(map);

            const request = {
                origin: OFFICE_LOCATION,
                destination: waypoints[waypoints.length - 1].location,
                waypoints: waypoints.slice(0, -1),
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING,
                avoidHighways: false,
                avoidTolls: false
            };

            directionsService.route(request, (response, status) => {
                if (status === "OK") {
                    directionsRenderer.setDirections(response);
                    routeRenderersById.set(routeId, { renderer: directionsRenderer, polyline: null });
                } else {
                    console.warn(`Route failed for ${routeId}:`, status);
                    createFallbackOfficeRoute(route, color, routeId);
                }
            });
        }

        function createFallbackOfficeRoute(route, color, routeId) {
            const routePath = [
                OFFICE_LOCATION,
                ...route.assigned_users.map(user => ({ lat: parseFloat(user.lat), lng: parseFloat(user.lng) }))
            ];

            const fallbackRoute = new google.maps.Polyline({
                path: routePath,
                geodesic: true,
                strokeColor: color,
                strokeOpacity: 0.7,
                strokeWeight: 4,
                zIndex: 250
            });

            fallbackRoute.setMap(map);
            routeRenderersById.set(routeId, { renderer: null, polyline: fallbackRoute });
        }

        function createHeatmap(data) {
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: data,
                map: map,
                radius: 30,
                opacity: 0.8
            });
        }

        function updateStats() {
            const totalRoutes = displayRoutes.length;
            const totalUsers = displayRoutes.reduce((sum, route) => sum + route.assigned_users.length, 0);
            const totalDrivers = displayRoutes.length;
            
            const utilizations = displayRoutes.map(route => route.assigned_users.length / route.vehicle_type);
            const avgUtilization = utilizations.length ? 
                (utilizations.reduce((a, b) => a + b, 0) / utilizations.length * 100).toFixed(1) : 0;

            document.getElementById('totalRoutes').textContent = totalRoutes;
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('avgUtilization').textContent = avgUtilization + '%';
            document.getElementById('totalDrivers').textContent = totalDrivers;
        }

        function updateAnalytics() {
            const totalUsers = displayRoutes.reduce((sum, route) => sum + route.assigned_users.length, 0);
            const totalCapacity = displayRoutes.reduce((sum, route) => sum + route.vehicle_type, 0);
            
            const assignmentRate = totalUsers && totalCapacity ? Math.min(100, (totalUsers / totalCapacity * 100)).toFixed(1) : 0;
            const capacityUtilization = totalCapacity ? (totalUsers / totalCapacity * 100).toFixed(1) : 0;
            
            let totalDistance = 0;
            let connectionCount = 0;
            displayRoutes.forEach(route => {
                route.assigned_users.forEach(user => {
                    totalDistance += haversineDistance(route.latitude, route.longitude, user.lat, user.lng);
                    connectionCount++;
                });
            });
            const avgDistance = connectionCount ? (totalDistance / connectionCount).toFixed(1) : 0;
            
            const efficiencyScore = calculateEfficiencyScore(displayRoutes).toFixed(1);
            
            const highEfficiency = displayRoutes.filter(r => (r.assigned_users.length / r.vehicle_type) >= 0.8).length;
            const mediumEfficiency = displayRoutes.filter(r => {
                const util = r.assigned_users.length / r.vehicle_type;
                return util >= 0.5 && util < 0.8;
            }).length;
            const lowEfficiency = displayRoutes.filter(r => (r.assigned_users.length / r.vehicle_type) < 0.5).length;

            document.getElementById('assignmentRate').textContent = assignmentRate + '%';
            document.getElementById('capacityUtilization').textContent = capacityUtilization + '%';
            document.getElementById('avgDistance').textContent = avgDistance + ' km';
            document.getElementById('efficiencyScore').textContent = efficiencyScore + '/10';
            document.getElementById('highEfficiencyRoutes').textContent = highEfficiency;
            document.getElementById('mediumEfficiencyRoutes').textContent = mediumEfficiency;
            document.getElementById('lowEfficiencyRoutes').textContent = lowEfficiency;

            generateSystemAlerts({
                assignmentRate: parseFloat(assignmentRate),
                capacityUtilization: parseFloat(capacityUtilization),
                avgDistance: parseFloat(avgDistance),
                efficiencyScore: parseFloat(efficiencyScore),
                lowEfficiency
            });
            
            // Show smart suggestions after analytics update
            if (displayRoutes.length > 0 && displayRoutes.length === originalRoutes.length) {
                setTimeout(suggestRouteOptimization, 2000);
            }
        }

        function calculateEfficiencyScore(routes) {
            if (routes.length === 0) return 0;

            let score = 0;
            const avgUtilization = routes.reduce((sum, r) => sum + (r.assigned_users.length / r.vehicle_type), 0) / routes.length;
            score += Math.min(avgUtilization * 10, 4);

            let totalDistance = 0;
            let connections = 0;
            routes.forEach(route => {
                route.assigned_users.forEach(user => {
                    totalDistance += haversineDistance(route.latitude, route.longitude, user.lat, user.lng);
                    connections++;
                });
            });
            const avgDistance = connections ? totalDistance / connections : 0;
            const distanceScore = Math.max(0, 3 - (avgDistance / 5) * 3);
            score += distanceScore;

            const utilizations = routes.map(r => r.assigned_users.length / r.vehicle_type);
            const stdDev = Math.sqrt(utilizations.reduce((sum, u) => sum + Math.pow(u - avgUtilization, 2), 0) / utilizations.length);
            const balanceScore = Math.max(0, 3 - stdDev * 6);
            score += balanceScore;

            return score;
        }

        function generateSystemAlerts(metrics) {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '';

            const alerts = [];

            if (metrics.capacityUtilization < 60) {
                alerts.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    message: `Low capacity utilization (${metrics.capacityUtilization}%) - Consider optimizing routes`
                });
            }

            if (metrics.avgDistance > 8) {
                alerts.push({
                    type: 'error',
                    icon: 'route',
                    message: `High average distance (${metrics.avgDistance} km) - Routes may be inefficient`
                });
            }

            if (metrics.lowEfficiency > originalRoutes.length * 0.3) {
                alerts.push({
                    type: 'warning',
                    icon: 'chart-line',
                    message: `${metrics.lowEfficiency} routes have low efficiency - Review assignments`
                });
            }

            if (metrics.efficiencyScore >= 8) {
                alerts.push({
                    type: 'success',
                    icon: 'check-circle',
                    message: `Excellent efficiency score (${metrics.efficiencyScore}/10)!`
                });
            }

            if (alerts.length === 0) {
                alerts.push({
                    type: 'success',
                    icon: 'thumbs-up',
                    message: 'All systems operating efficiently'
                });
            }

            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.type}`;
                alertDiv.innerHTML = `<i class="fas fa-${alert.icon}"></i> ${alert.message}`;
                container.appendChild(alertDiv);
            });
        }

        // Utility Functions
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function adjustBrightness(color, amount) {
            const usePound = color[0] === "#";
            const col = usePound ? color.slice(1) : color;
            const num = parseInt(col, 16);
            let r = (num >> 16) + amount;
            let b = (num >> 8 & 0x00FF) + amount;
            let g = (num & 0x0000FF) + amount;
            r = r > 255 ? 255 : r < 0 ? 0 : r;
            b = b > 255 ? 255 : b < 0 ? 0 : b;
            g = g > 255 ? 255 : g < 0 ? 0 : g;
            return (usePound ? "#" : "") + String("000000" + (g | (b << 8) | (r << 16)).toString(16)).slice(-6);
        }

        function showAlert(type, message) {
            const container = document.getElementById('alertsContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            container.appendChild(alertDiv);
        }

        function showRouteInfo(route, index) {
            const popup = document.getElementById('routeInfoPopup');
            const utilization = (route.assigned_users.length / route.vehicle_type * 100).toFixed(1);
            
            const content = `
                <div style="font-family: Inter, sans-serif;">
                    <h4 style="margin: 0 0 15px 0; color: #f1f5f9; display: flex; align-items: center; gap: 8px;">
                        <div style="width: 28px; height: 28px; background: linear-gradient(45deg, ${ROUTE_COLORS[index % ROUTE_COLORS.length]}, ${adjustBrightness(ROUTE_COLORS[index % ROUTE_COLORS.length], -30)}); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${index + 1}</div>
                        Route ${index + 1}
                    </h4>
                    <div style="display: grid; gap: 8px; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">Driver:</span>
                            <span style="font-weight: 600; color: #f1f5f9;">${route.driver_id}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">Utilization:</span>
                            <span style="font-weight: 600; color: #f1f5f9;">${utilization}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">Efficiency:</span>
                            <span style="font-weight: 600; color: #f1f5f9;">${utilization >= 80 ? '🟢 High' : utilization >= 50 ? '🟡 Medium' : '🔴 Low'}</span>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <div style="background: #334155; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, ${ROUTE_COLORS[index % ROUTE_COLORS.length]}, ${adjustBrightness(ROUTE_COLORS[index % ROUTE_COLORS.length], -20)}); width: ${utilization}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('routeInfoContent').innerHTML = content;
            popup.style.display = 'block';
            
            setTimeout(() => popup.style.display = 'none', 5000);
        }

        // ✅ OPTIMIZATION 1: Client-side filtering (no server fetch)
        function handleSearch() {
            const query = document.getElementById("searchInput").value.toLowerCase().trim();
            
            if (!query) {
                displayRoutes = [...originalRoutes];
            } else {
                displayRoutes = originalRoutes.filter(route =>
                    route.driver_id.toLowerCase().includes(query) ||
                    route.vehicle_id.toLowerCase().includes(query) ||
                    route.assigned_users.some(user => 
                        user.user_id.toLowerCase().includes(query) ||
                        (user.first_name && user.first_name.toLowerCase().includes(query)) ||
                        (user.email && user.email.toLowerCase().includes(query))
                    )
                );
            }
            
            updateUI();
            renderMap();
        }

        function filterCluster() {
            const selectedValue = document.getElementById("clusterSelect").value;
            
            if (selectedValue === "all") {
                displayRoutes = [...originalRoutes];
            } else {
                const index = parseInt(selectedValue);
                displayRoutes = originalRoutes[index] ? [originalRoutes[index]] : [];
            }
            
            updateUI();
            renderMap();
        }

        function filterByUtilization() {
            const minUtilizationPercent = parseInt(document.getElementById("utilizationRange").value);
            const minUtilization = minUtilizationPercent / 100;
            
            displayRoutes = originalRoutes.filter(route => {
                const utilization = route.assigned_users.length / route.vehicle_type;
                return utilization >= minUtilization;
            });
            
            updateUI();
            renderMap();
        }

        function highlightRoute(index) {
            document.querySelectorAll('.cluster-color').forEach(el => el.classList.remove('active'));
            
            const highlightedElement = document.querySelector(`.cluster-color:nth-child(${index + 1})`);
            if (highlightedElement) {
                highlightedElement.classList.add('active');
            }
            
            if (originalRoutes[index]) {
                displayRoutes = [originalRoutes[index]];
                updateUI();
                renderMap();
                
                const route = displayRoutes[0];
                if (route.assigned_users.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(OFFICE_LOCATION);
                    route.assigned_users.forEach(user => {
                        bounds.extend(new google.maps.LatLng(parseFloat(user.lat), parseFloat(user.lng)));
                    });
                    map.fitBounds(bounds);
                    
                    // ✅ Cinematic spotlight effect
                    activateSpotlight(route);
                }
            }
        }
        
        // ✅ Cinematic spotlight effect
        function activateSpotlight(route) {
            const spotlight = document.getElementById('mapSpotlight');
            if (!spotlight) return;
            
            const centerLat = parseFloat(route.latitude);
            const centerLng = parseFloat(route.longitude);
            
            // Calculate screen position of route center
            const projection = map.getProjection();
            if (!projection) return;
            
            spotlight.classList.add('active');
            
            // Fade out after 3 seconds
            setTimeout(() => {
                spotlight.classList.remove('active');
            }, 3000);
        }
        
        // ✅ Toast notification system
        function showToast(message, actions = []) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const actionsHTML = actions.length > 0 ? `
                <div class="toast-actions">
                    ${actions.map(action => `
                        <button class="toast-btn toast-btn-${action.type || 'secondary'}" onclick="${action.onClick}">
                            ${action.label}
                        </button>
                    `).join('')}
                </div>
            ` : '';
            
            toast.innerHTML = `
                <div class="toast-header">
                    <div class="toast-icon">💡</div>
                    <div class="toast-title">Smart Suggestion</div>
                </div>
                <div class="toast-message">${message}</div>
                ${actionsHTML}
            `;
            
            container.appendChild(toast);
            
            // Auto-dismiss after 8 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 8000);
        }
        
        // Example: Show toast for route optimization
        function suggestRouteOptimization() {
            const lowEfficiencyRoutes = displayRoutes.filter(r => 
                (r.assigned_users.length / r.vehicle_type) < 0.5
            );
            
            if (lowEfficiencyRoutes.length > 0) {
                showToast(
                    `Found ${lowEfficiencyRoutes.length} routes with low efficiency. Consider rebalancing for better utilization.`,
                    [
                        { label: 'Optimize Now', type: 'primary', onClick: 'refreshData()' },
                        { label: 'View Details', type: 'secondary', onClick: 'console.log("View details")' },
                        { label: 'Dismiss', type: 'secondary', onClick: 'event.target.closest(".toast").remove()' }
                    ]
                );
            }
        }

        // Toggle Functions
        function toggleUsers() {
            displayState.users = !displayState.users;
            renderMap();
            updateDisplayButtons();
        }

        function toggleDrivers() {
            displayState.drivers = !displayState.drivers;
            renderMap();
            updateDisplayButtons();
        }

        function toggleRouteLines() {
            displayState.routeLines = !displayState.routeLines;
            renderMap();
            updateDisplayButtons();
        }

        function toggleHeatmap() {
            displayState.heatmap = !displayState.heatmap;
            renderMap();
            updateDisplayButtons();
        }

        function showOptimalPaths() {
            displayState.optimalPaths = !displayState.optimalPaths;
            renderMap();
            updateDisplayButtons();
        }

        function updateDisplayButtons() {
            const buttons = [
                { id: 'toggleUsersBtn', state: displayState.users },
                { id: 'toggleDriversBtn', state: displayState.drivers },
                { id: 'toggleRouteLinesBtn', state: displayState.routeLines },
                { id: 'toggleHeatmapBtn', state: displayState.heatmap },
                { id: 'showOptimalBtn', state: displayState.optimalPaths }
            ];

            buttons.forEach(({ id, state }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    if (state) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }

        // Map Control Functions
        function centerOnOffice() {
            map.setCenter(OFFICE_LOCATION);
            map.setZoom(12);
        }

        function fitAllRoutes() {
            if (displayRoutes.length === 0) return;

            const bounds = new google.maps.LatLngBounds();
            bounds.extend(OFFICE_LOCATION);
            
            displayRoutes.forEach(route => {
                bounds.extend(new google.maps.LatLng(parseFloat(route.latitude), parseFloat(route.longitude)));
                route.assigned_users.forEach(user => {
                    bounds.extend(new google.maps.LatLng(parseFloat(user.lat), parseFloat(user.lng)));
                });
            });
            
            map.fitBounds(bounds);
        }

        function refreshData() {
            showAlert('success', 'Refreshing route data...');
            loadRouteData();
        }

        function togglePlaceNames() {
            showPlaceNames = !showPlaceNames;
            const btn = document.getElementById('togglePlaceNamesBtn');
            
            if (showPlaceNames) {
                map.setOptions({ styles: originalMapStyles });
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Hide Places';
            } else {
                map.setOptions({ styles: cleanMapStyles });
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Place Names';
            }
        }

        // Export Functions
        function exportAnalytics() {
            const csvData = displayRoutes.map((route, index) => ({
                route_id: index + 1,
                driver_id: route.driver_id,
                vehicle_id: route.vehicle_id,
                capacity: route.vehicle_type,
                assigned_users: route.assigned_users.length,
                utilization_percent: ((route.assigned_users.length / route.vehicle_type) * 100).toFixed(2),
                efficiency_rating: route.assigned_users.length / route.vehicle_type >= 0.8 ? 'High' : 
                                 route.assigned_users.length / route.vehicle_type >= 0.5 ? 'Medium' : 'Low',
                driver_lat: route.latitude,
                driver_lng: route.longitude
            }));

            if (csvData.length === 0) {
                showAlert('warning', 'No data available to export.');
                return;
            }

            const csv = [
                Object.keys(csvData[0]).join(','),
                ...csvData.map(row => Object.values(row).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `routeflow-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('success', 'Analytics data exported successfully!');
        }

        function generateReport() {
            const report = {
                generated_at: new Date().toISOString(),
                platform: "RouteFlow - Smart Driver Assignment Platform",
                summary: {
                    total_routes: displayRoutes.length,
                    total_users: displayRoutes.reduce((sum, r) => sum + r.assigned_users.length, 0),
                    total_capacity: displayRoutes.reduce((sum, r) => sum + r.vehicle_type, 0),
                    average_utilization: displayRoutes.length > 0 ? (displayRoutes.reduce((sum, r) => sum + (r.assigned_users.length / r.vehicle_type), 0) / displayRoutes.length * 100).toFixed(2) : 0,
                    efficiency_score: calculateEfficiencyScore(displayRoutes).toFixed(2)
                },
                route_details: displayRoutes.map((route, index) => ({
                    route_id: index + 1,
                    driver_id: route.driver_id,
                    vehicle_info: {
                        vehicle_id: route.vehicle_id,
                        capacity: route.vehicle_type
                    },
                    assignment_info: {
                        users_assigned: route.assigned_users.length,
                        utilization_percent: ((route.assigned_users.length / route.vehicle_type) * 100).toFixed(2),
                        efficiency_rating: route.assigned_users.length / route.vehicle_type >= 0.8 ? 'High' : 
                                         route.assigned_users.length / route.vehicle_type >= 0.5 ? 'Medium' : 'Low'
                    },
                    location: {
                        latitude: route.latitude,
                        longitude: route.longitude
                    },
                    assigned_users: route.assigned_users
                }))
            };

            if (displayRoutes.length === 0) {
                showAlert('warning', 'No data available to generate report.');
                return;
            }

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `routeflow-report-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('success', 'Comprehensive report generated successfully!');
        }

        function exportMapImage() {
            showAlert('warning', 'Map capture feature requires external libraries. Please use your browser\'s screenshot tool.');
        }
    </script>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Google Maps API with visualization library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjESclgKTCpmdmHKc7bzCKIQtYe_vIbb4&libraries=places,visualization&callback=initMap&libraries=places" async defer></script>
</body>
</html>
